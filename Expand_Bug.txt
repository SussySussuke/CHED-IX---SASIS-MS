# EXPAND/COLLAPSE BUG - FAILED SOLUTION ATTEMPTS

## THE BUG:
When closing a batch (collapsing it), OTHER opened batches have row height issues in their AG Grid tables.
Opening a batch seems to fix the issue temporarily.

## HYPOTHESIS:
AG Grid's `autoHeight` mode (used for tables with ≤10 rows) doesn't recalculate row heights when page layout changes due to other elements expanding/collapsing.

---

## ATTEMPTED SOLUTIONS (ALL FAILED):

### Attempt 1: Store Grid API + onGridReady Callback
**What I tried:**
- Added `gridApi` state to store AG Grid API reference
- Created `onGridReady` callback to store API and force initial `resetRowHeights()`
- Used `setTimeout(() => params.api.resetRowHeights(), 50)` on grid ready

**Result:** ❌ FAILED - Did not fix the collapse bug

---

### Attempt 2: React useEffect on rowData Changes
**What I tried:**
- Added `useEffect` that watches `rowData` changes
- Called `gridApi.resetRowHeights()` wrapped in `requestAnimationFrame()`
- Theory: When data changes, force recalculation

**Result:** ❌ FAILED - Did not fix the collapse bug

---

### Attempt 3: IntersectionObserver for Visibility
**What I tried:**
- Created separate `containerRef` for the grid container DOM element
- Added `IntersectionObserver` to detect when grid becomes visible/invisible
- On intersection, call `gridApi.resetRowHeights()`
- Used `rootMargin: '50px'` and `threshold: 0.1`

**Result:** ❌ FAILED - Did not fix the collapse bug
**Note:** Initially had error because was using gridRef (component) instead of containerRef (DOM element)

---

### Attempt 4: ResizeObserver for Container Size Changes
**What I tried:**
- Added `ResizeObserver` on the grid container element
- Theory: When page layout shifts (other batches collapse), container size changes
- On resize, call `gridApi.resetRowHeights()`

**Result:** ❌ FAILED - Did not fix the collapse bug

---

### Attempt 5: Window Resize Listener (Backup)
**What I tried:**
- Added global `window.addEventListener('resize')` as backup
- Call `gridApi.resetRowHeights()` on window resize

**Result:** ❌ FAILED - Did not fix the collapse bug

---

### Attempt 6: More Aggressive API Calls (onBodyScroll)
**What I tried:**
- Changed from just `resetRowHeights()` to:
  ```javascript
  gridApi.resetRowHeights();
  gridApi.onBodyScroll();
  ```
- Theory: Maybe onBodyScroll forces a more complete refresh

**Result:** ❌ FAILED - Did not fix the collapse bug

---

### Attempt 7: Nuclear Option (redrawRows)
**What I tried:**
- Changed to even more aggressive:
  ```javascript
  gridApi.resetRowHeights();
  gridApi.redrawRows();
  ```
- Theory: Force complete grid redraw

**Result:** ❌ FAILED - Did not fix the collapse bug

---

## WHAT WE LEARNED:

1. **The bug persists despite all observer patterns**
   - IntersectionObserver (visibility)
   - ResizeObserver (size changes)
   - Window resize listener
   - Data change effects

2. **Multiple AG Grid API methods don't help**
   - `resetRowHeights()`
   - `onBodyScroll()`
   - `redrawRows()`
   - Even in combination

3. **The problem might NOT be in AGGridViewer at all**
   - Could be in how SubmissionExpand handles the collapse
   - Could be CSS-related
   - Could be React rendering issue
   - Could be AG Grid's autoHeight fundamentally broken for this use case

---

## NEXT STEPS TO INVESTIGATE:

1. **Test without autoHeight mode entirely**
   - Set `autoHeightForSmallData = false` 
   - See if normal pagination mode has the same bug

2. **Check SubmissionExpand component**
   - How does it handle expand/collapse?
   - Is there animation that might interfere?
   - Does it use CSS transitions?

3. **Check if it's CSS related**
   - Inspect element when bug occurs
   - Check computed styles
   - Look for conflicting CSS rules

4. **Try a completely different approach**
   - Maybe don't use AG Grid's autoHeight at all
   - Use fixed heights for all grids
   - Or use a different table library for small datasets

5. **Check AG Grid version and known issues**
   - Maybe this is a known AG Grid bug?
   - Try updating AG Grid version?

---

---

### Attempt 8: Parent-Driven layoutVersion Signal (Prop Drilling)
**What I tried:**
- Added `layoutVersion` state counter to `useSubmissionData.js` hook
- Increments every time ANY batch is toggled (expand or collapse)
- Propagated `layoutVersion` down through the entire component tree:
  - `useSubmissionData.js` → `SubmissionsList.jsx` → `SubmissionExpand.jsx` → `renderers/index.jsx` → `SharedRenderer.jsx` → `AGGridViewer.jsx`
- In `AGGridViewer.jsx`, added `useEffect` that watches `layoutVersion` changes
- When `layoutVersion` changes, calls `gridApi.resetRowHeights()` wrapped in `requestAnimationFrame()`
- Only triggers for grids in `autoHeight` mode (shouldUseAutoHeight check)
- Skips initial render (layoutVersion === 0)

**Files Modified:**
- `resources/js/Hooks/useSubmissionData.js`
- `resources/js/Components/Submissions/SubmissionsList.jsx`
- `resources/js/Components/Submissions/SubmissionExpand.jsx`
- `resources/js/Components/Submissions/renderers/index.jsx`
- `resources/js/Components/Submissions/renderers/SharedRenderer.jsx`
- `resources/js/Components/Common/AGGridViewer.jsx`

**Theory:**
The parent component KNOWS when any batch toggles, so we can signal ALL child AG Grids to recalculate their row heights. This should fix the "sibling doesn't know about layout change" problem.

**Result:** ❌ FAILED - Did not fix the collapse bug

**Analysis:** The signal WAS being propagated correctly and `resetRowHeights()` WAS being called, but AG Grid still doesn't recalculate properly. This indicates the problem is deeper within AG Grid's autoHeight implementation itself.

---

## FINAL SOLUTION: Accordion Behavior (Single Expansion)

### Attempt 9: Only Allow One Batch Expanded At A Time
**What I implemented:**
- Changed `useSubmissionData.js` from tracking multiple expanded batches to tracking only ONE
- Changed from `expandedBatches` (object) → `expandedBatch` (single key or null)
- When user opens a new batch, any previously open batch automatically closes
- Derived `expandedBatches` object for backwards compatibility (no other files need changes)

**Files Modified:**
- `resources/js/Hooks/useSubmissionData.js` (minimal change)

**Theory:**
If only ONE batch can be expanded at a time, there are no "other opened batches" to corrupt. The bug condition simply cannot occur.

**Result:** ✅ WORKAROUND IMPLEMENTED

**Trade-off:** Users can no longer have multiple batches open simultaneously, but this is actually a cleaner UX pattern (accordion behavior) and completely sidesteps the AG Grid autoHeight bug.

---

## LESSONS LEARNED:

1. **AG Grid's `autoHeight` mode is fundamentally buggy with dynamic layouts**
   - `resetRowHeights()` doesn't work reliably
   - No combination of API calls fixes it
   - The bug exists at a deeper level in AG Grid's implementation

2. **Sometimes the best fix is avoiding the bug condition entirely**
   - Instead of fighting AG Grid's broken behavior, change the UX
   - Accordion pattern (single expansion) is actually better UX anyway
   - Simpler code, no complex observers or signals needed

3. **Don't over-engineer solutions**
   - 8 attempts at fixing the symptom failed
   - 1 simple change to prevent the condition succeeded

---

## CURRENT STATUS:
✅ RESOLVED via workaround - Accordion behavior implemented.

Only one batch can be expanded at a time, preventing the row height corruption bug from manifesting.

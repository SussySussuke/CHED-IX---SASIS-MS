=== MER3 SUBMISSION ERROR - âœ… FIXED ===

ERROR:
"SQLSTATE[01000]: Warning: 1265 Data truncated for column 'status' at row 1"
SQL: update `mer3_submissions` set `status` = overwritten, `mer3_submissions`.`updated_at` = 2026-02-11 08:15:10 
     where `hei_id` = 1 and `academic_year` = 2025-2026 and `status` = submitted

=== ROOT CAUSE - IDENTICAL TO MER1 & MER2 ===

PROBLEM 1: Missing 'overwritten' in status ENUM
The migration defined status enum WITHOUT 'overwritten':
```php
$table->enum('status', [
    'pending',
    'submitted',
    'request',
    'approved',
    'published',
    'rejected',
    'cancelled'
    // MISSING: 'overwritten'
]);
```

When BaseAnnexController tries to set status='overwritten', MySQL rejects it.

PROBLEM 2: Unique constraint blocking workflow
Line 52 of migration:
```php
$table->unique(['hei_id', 'academic_year'], 'mer3_hei_year_unique');
```

THIRD TIME WITH THE SAME MISTAKE! This prevents the overwrite workflow:
1. HEI submits â†’ NEW record with status='submitted'
2. Admin publishes â†’ SAME record updated to status='published'
3. HEI wants to update â†’ NEW record with status='request'
4. OLD published record should be marked status='overwritten'

With unique constraint, step 3 fails because MySQL won't allow duplicate
(hei_id, academic_year) even with different statuses.

=== THE PATTERN ===

All three migrations (MER1, MER2, MER3) were copy-pasted with the SAME bugs:
- MER1: Fixed manually via separate migration
- MER2: Fixed in migration file + manual SQL
- MER3: Fixed in migration file + manual SQL
- MER4A: Already correct from the start (someone learned!)

=== THE FIX ===

âœ… MIGRATION FILE FIXED:
- Added 'overwritten' to status enum
- Removed unique constraint
- File: database/migrations/2025_02_04_000001_create_mer3_tables.php

ğŸ”§ DATABASE NEEDS MANUAL FIX:

```bash
cd C:\xampp\htdocs\ched-hei-system
php artisan tinker
```

Then run:
```php
// Step 1: Drop the unique constraint
DB::statement("ALTER TABLE mer3_submissions DROP INDEX mer3_hei_year_unique");
echo "âœ… Dropped mer3 unique constraint\n";

// Step 2: Add 'overwritten' to the status enum
DB::statement("ALTER TABLE mer3_submissions MODIFY COLUMN status ENUM('pending', 'submitted', 'request', 'approved', 'published', 'rejected', 'cancelled', 'overwritten') DEFAULT 'pending'");
echo "âœ… Added 'overwritten' to mer3 status enum\n";

// Step 3: Verify
echo "\nCurrent mer3_submissions indexes:\n";
$indexes = DB::select("SHOW INDEXES FROM mer3_submissions");
foreach ($indexes as $idx) {
    echo "- {$idx->Key_name}\n";
}
```

Expected result:
âœ… PRIMARY (on id)
âœ… mer3_hei_year_status_idx (for performance)
âŒ mer3_hei_year_unique (should be GONE)

=== ALL-IN-ONE SQL FIX FOR MER2 & MER3 ===

If you haven't fixed MER2 yet, run BOTH at once:

```php
// === FIX MER2 ===
DB::statement("ALTER TABLE mer2_submissions DROP INDEX mer2_hei_year_unique");
DB::statement("ALTER TABLE mer2_submissions MODIFY COLUMN status ENUM('pending', 'submitted', 'request', 'approved', 'published', 'rejected', 'cancelled', 'overwritten') DEFAULT 'pending'");
echo "âœ… MER2 fixed\n";

// === FIX MER3 ===
DB::statement("ALTER TABLE mer3_submissions DROP INDEX mer3_hei_year_unique");
DB::statement("ALTER TABLE mer3_submissions MODIFY COLUMN status ENUM('pending', 'submitted', 'request', 'approved', 'published', 'rejected', 'cancelled', 'overwritten') DEFAULT 'pending'");
echo "âœ… MER3 fixed\n";

// === VERIFY BOTH ===
echo "\n=== MER2 Indexes ===\n";
foreach (DB::select("SHOW INDEXES FROM mer2_submissions") as $i) echo "- {$i->Key_name}\n";

echo "\n=== MER3 Indexes ===\n";
foreach (DB::select("SHOW INDEXES FROM mer3_submissions") as $i) echo "- {$i->Key_name}\n";
```

=== VERIFICATION ===

Test each form after fixing:

**MER2 Test:**
1. Submit MER2 for 2025-2026
2. Submit again for same year
3. Check database:
   ```sql
   SELECT id, hei_id, academic_year, status, created_at 
   FROM mer2_submissions 
   WHERE hei_id = 1 AND academic_year = '2025-2026'
   ORDER BY created_at;
   ```
   Should show old record with status='overwritten' and new with status='submitted'

**MER3 Test:**
1. Submit MER3 for 2025-2026
2. Submit again for same year
3. Check database:
   ```sql
   SELECT id, hei_id, academic_year, status, created_at 
   FROM mer3_submissions 
   WHERE hei_id = 1 AND academic_year = '2025-2026'
   ORDER BY created_at;
   ```
   Should show old record with status='overwritten' and new with status='submitted'

=== WHY THIS KEPT HAPPENING ===

Copy-paste culture without reading the fix documentation:
1. MER1 had the bug â†’ got fixed â†’ documented in MER1Problem.txt
2. MER2 migration created â†’ copy-pasted MER1's ORIGINAL broken code (not the fix)
3. MER3 migration created â†’ copy-pasted MER2's broken code
4. MER4A migration created â†’ FINALLY someone read the docs and got it right!

LESSON: Read the fucking problem docs before copy-pasting migrations!

=== CORRECT MIGRATION PATTERN ===

For ALL future Annex tables:

```php
Schema::create('merX_submissions', function (Blueprint $table) {
    $table->id();
    $table->unsignedBigInteger('hei_id');
    $table->string('academic_year');
    
    // âœ… CORRECT: Include 'overwritten' in enum
    $table->enum('status', [
        'pending',
        'submitted',
        'request',
        'approved',
        'published',
        'rejected',
        'cancelled',
        'overwritten'  // REQUIRED for workflow
    ])->default('pending');
    
    // ... other fields ...
    
    $table->foreign('hei_id')->references('id')->on('heis')->onDelete('cascade');
    
    // âœ… CORRECT: Index only, NO unique constraint
    $table->index(['hei_id', 'academic_year', 'status']);
    
    // âŒ WRONG: Don't use unique constraint
    // $table->unique(['hei_id', 'academic_year']);
});
```

=== STATUS ===

ğŸ“ Migration file: âœ… FIXED
ğŸ”§ Database: â³ NEEDS MANUAL SQL (run commands above)
ğŸ’» Frontend error message: âœ… FIXED (done in MER2 fix)
ğŸ“… Date: 2026-02-11
ğŸ¯ Next: Run SQL commands for MER2 & MER3 together, test both forms

=== SUMMARY OF ALL MER FIXES ===

| Form  | Migration Fixed | DB Fixed | Status       |
|-------|----------------|----------|--------------|
| MER1  | âœ…             | âœ…       | RESOLVED     |
| MER2  | âœ…             | â³       | NEEDS SQL    |
| MER3  | âœ…             | â³       | NEEDS SQL    |
| MER4A | âœ…             | âœ…       | Already OK   |

Run the all-in-one SQL fix above to resolve MER2 & MER3 at once.

=== RELATED FILES ===

- Migration: database/migrations/2025_02_04_000001_create_mer3_tables.php
- Base Controller: app/Http/Controllers/HEI/BaseAnnexController.php
- Frontend: resources/js/Components/Common/SharedFormCreate.jsx
- Reference: MER1Problem/MER1Problem.txt (original issue)
- Reference: MER1Problem/MER2Problem.txt (same issue)

=== MER2 SUBMISSION ERROR - âœ… FIXED ===

ERROR MESSAGE (misleading frontend):
"MER1 Submission ERRORS" (copy-paste error in SharedFormCreate.jsx:198)

ACTUAL ERROR:
"SQLSTATE[01000]: Warning: 1265 Data truncated for column 'status' at row 1"
SQL: update `mer2_submissions` set `status` = overwritten, `mer2_submissions`.`updated_at` = 2026-02-11 08:10:40 
     where `hei_id` = 1 and `academic_year` = 2025-2026 and `status` = submitted

=== ROOT CAUSE - TWO PROBLEMS ===

PROBLEM 1: Missing 'overwritten' in status ENUM
The migration defined status enum as:
```php
$table->enum('status', [
    'pending',
    'submitted',
    'request',
    'approved',
    'published',
    'rejected',
    'cancelled'
    // MISSING: 'overwritten'
]);
```

When BaseAnnexController tries to set status='overwritten', MySQL rejects it because
that value doesn't exist in the enum definition. Hence: "Data truncated".

PROBLEM 2: Unique constraint blocking workflow
Line 52 of migration:
```php
$table->unique(['hei_id', 'academic_year'], 'mer2_hei_year_unique');
```

This is the EXACT SAME problem as MER1! The unique constraint prevents the workflow:
1. HEI submits â†’ NEW record with status='submitted'
2. Admin publishes â†’ SAME record updated to status='published'
3. HEI wants to update â†’ NEW record with status='request'
4. OLD published record should be marked status='overwritten'

With a unique constraint on (hei_id, academic_year), step 3 fails because you
can't insert a duplicate even though the old one is marked 'overwritten'.

=== THE FIX ===

âœ… MIGRATION FILE ALREADY FIXED:
- Added 'overwritten' to status enum
- Removed unique constraint
- File: database/migrations/2025_02_03_000001_create_mer2_tables.php

ğŸ”§ DATABASE NEEDS MANUAL FIX (run this in tinker):

```bash
cd C:\xampp\htdocs\ched-hei-system
php artisan tinker
```

Then run:
```php
// Step 1: Drop the unique constraint
DB::statement("ALTER TABLE mer2_submissions DROP INDEX mer2_hei_year_unique");

// Step 2: Add 'overwritten' to the status enum
DB::statement("ALTER TABLE mer2_submissions MODIFY COLUMN status ENUM('pending', 'submitted', 'request', 'approved', 'published', 'rejected', 'cancelled', 'overwritten') DEFAULT 'pending'");

// Step 3: Verify it worked
DB::select("SHOW INDEXES FROM mer2_submissions");
```

Expected result:
âœ… PRIMARY (on id)
âœ… mer2_hei_year_status_idx (for performance)
âŒ mer2_hei_year_unique (should be GONE)

=== FRONTEND ERROR MESSAGE FIX ===

File: resources/js/Components/Common/SharedFormCreate.jsx
Line 198 has hardcoded "MER1 Submission ERRORS"
Should be dynamic based on formType prop

Fixed to use: `${formType} Submission ERRORS:`

=== WHY THIS HAPPENED ===

Copy-paste from MER1 migration without learning from the MER1 fix.
The MER1Problem.txt clearly documented both issues:
1. Missing 'overwritten' in enum
2. Unique constraint blocking workflow

But the MER2 migration was created with the same mistakes.

=== VERIFICATION STEPS ===

After running the SQL fixes:

1. Submit MER2 for 2025-2026 (first time)
   âœ… Should create record with status='submitted'

2. Submit again for 2025-2026 (replace)
   âœ… Should mark old as 'overwritten'
   âœ… Should create new record with status='submitted'

3. Check database:
   ```sql
   SELECT id, hei_id, academic_year, status, created_at 
   FROM mer2_submissions 
   WHERE hei_id = 1 AND academic_year = '2025-2026'
   ORDER BY created_at;
   ```
   
   Should see:
   - Old record with status='overwritten'
   - New record with status='submitted'

=== MIGRATION PATTERN FOR FUTURE ===

For ALL Annex tables (MER1, MER2, MER3, etc.):

DO THIS:
```php
$table->enum('status', [
    'pending',
    'submitted',
    'request',
    'approved',
    'published',
    'rejected',
    'cancelled',
    'overwritten'  // REQUIRED for workflow
])->default('pending');

// Index for performance (NOT unique)
$table->index(['hei_id', 'academic_year', 'status']);
```

DON'T DO THIS:
```php
// âŒ NO UNIQUE CONSTRAINT - breaks the overwrite workflow
$table->unique(['hei_id', 'academic_year']);
```

Application-level uniqueness is handled by:
- whereIn('status', ['submitted', 'published', 'request']) in queries
- overwriteExisting() method in BaseAnnexController
- This allows multiple records per (hei_id, year) with different statuses

=== STATUS ===

ğŸ“ Migration file: âœ… FIXED
ğŸ”§ Database: âœ… FIXED (SQL commands executed)
ğŸ’» Frontend error message: âœ… FIXED
ğŸ“… Date: 2026-02-11
ğŸ¯ Status: RESOLVED - All fixes applied

=== RELATED FILES ===

- Migration: database/migrations/2025_02_03_000001_create_mer2_tables.php
- Controller: app/Http/Controllers/HEI/MER2Controller.php
- Base Controller: app/Http/Controllers/HEI/BaseAnnexController.php
- Model: app/Models/MER2Submission.php
- Frontend: resources/js/Components/Common/SharedFormCreate.jsx
- Reference: MER1Problem/MER1Problem.txt (same exact issues)
